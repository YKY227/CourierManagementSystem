// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}


// enums.prisma

enum RegionCode {
  central
  east
  west
  north
  north_east   // maps to "north-east" in TS
  island_wide  // maps to "island-wide"
}

enum VehicleType {
  bike
  car
  van
  lorry
}

enum JobType {
  scheduled
  ad_hoc       // "ad-hoc"
}

enum JobStatus {
  booked          // created but not yet in assignment queue
  pending_assign  // (optional) if you decide to distinguish
  assigned
  out_for_pickup
  in_transit      // you can align with "in-progress" in TS if you have it
  completed
  failed
  cancelled
}

enum DriverStatus {
  offline
  available
  on_job
}

enum AssignmentMode {
  auto
  manual
}

enum AssignmentFailureReason {
  NO_ELIGIBLE_DRIVER
  NO_CAPACITY
  OUTSIDE_WORKING_HOURS
  REGION_MISMATCH
  VEHICLE_MISMATCH
  OTHER
}

enum JobStopType {
  PICKUP
  DROPOFF
  RETURN
}

enum JobStopStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

model Driver {
  id        String   @id @default(cuid())
  // Core identity
  name      String
  email     String?
  phone     String?

  // Operations metadata
  vehicleType       VehicleType
  vehiclePlate      String?
  primaryRegion     RegionCode
  secondaryRegions  RegionCode[] // Postgres enum[] via Prisma

  // Capacity & working hours
  maxJobsPerDay     Int
  maxJobsPerSlot    Int
  workDayStartHour  Int         // e.g. 8 (8 AM)
  workDayEndHour    Int         // e.g. 17 (5 PM)

  // Status & presence
  isActive          Boolean     @default(true)
  currentStatus     DriverStatus @default(offline)
  lastSeenAt        DateTime?
  locationLat       Float?      // from your "location" field
  locationLng       Float?

  // Auth linkage (if you integrate with an auth user table later)
  authUserId        String?     // external auth provider / users table

  // Operational notes
  assignedJobCountToday Int     @default(0)
  notes                 String?

  // Relations
  assignments       JobAssignment[]
  stopsCompleted    JobStop[]       @relation("StopCompletedByDriver")

  currentJobs            Job[]          @relation("CurrentDriverJobs")
  proofPhotos            ProofPhoto[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}


model Job {
  id        String  @id @default(cuid())

  // Public-facing tracking code (for /track/:publicId)
  publicId  String  @unique

  // High-level customer info
  customerName  String
  customerEmail String?
  customerPhone String?

  // Booking / service info
  serviceType   String?   // maps to your ServiceType union; can become enum later
  routeType     String?   // maps to RouteType union

  // Pickup summary (for admin lists & driver jobs)
  pickupRegion  RegionCode
  pickupDate    DateTime?    // derived from schedule
  pickupSlot    String?      // e.g. "12:00 – 15:00"

  // Aggregated metrics
  stopsCount            Int       @default(0)
  totalBillableWeightKg Decimal?  @db.Decimal(10, 2)

  jobType       JobType
  status        JobStatus         @default(booked)
  assignmentMode        AssignmentMode?
  assignmentFailureReason AssignmentFailureReason?

  // Source & creation metadata
  source        String?           // "web" | "whatsapp" | "admin"
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  // Optional convenience link to current assigned driver
  currentDriverId String?
  currentDriver   Driver?    @relation("CurrentDriverJobs", fields: [currentDriverId], references: [id])

  // Detailed booking structures (JSON for now)
  pickupDetails   Json?     // PickupLocation
  deliveryPoints  Json?     // DeliveryPoint[]
  items           Json?     // DeliveryItem[]
  scheduleInfo    Json?     // ScheduleInfo

  // Debug info for assignment policy drawer
  assignmentScoreDebug   Json?    // full scoring breakdown
  hardConstraintResults  Json?    // optional: per-constraint pass/fail map

  // Relations
  stops        JobStop[]
  assignments  JobAssignment[]
  proofPhotos  ProofPhoto[]

  @@index([status])
  @@index([pickupDate])
  @@index([pickupRegion])
}

model JobStop {
  id        String  @id @default(cuid())

  jobId     String
  job       Job     @relation(fields: [jobId], references: [id])

  sequenceIndex Int              // 0,1,2.. for route ordering
  type          JobStopType      // PICKUP / DROPOFF / RETURN

  label         String           // short label shown to driver (“Pickup – Tech Hygiene Hub”)
  addressLine   String
  postalCode    String?
  region        RegionCode

  contactName   String?
  contactPhone  String?

  status        JobStopStatus    @default(PENDING)
  proofPhotoUrl String?
  notes         String?

  completedAt         DateTime?
  completedByDriverId String?
  completedByDriver   Driver?    @relation("StopCompletedByDriver", fields: [completedByDriverId], references: [id])

   proofPhotos         ProofPhoto[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([jobId, sequenceIndex])
}

model JobAssignment {
  id        String  @id @default(cuid())

  jobId     String
  job       Job     @relation(fields: [jobId], references: [id])

  driverId  String
  driver    Driver  @relation(fields: [driverId], references: [id])

  mode      AssignmentMode
  failureReason AssignmentFailureReason?

  // For policy debug drawer
  totalScore            Float?
  scoreComponents       Json?       // { regionScore, loadBalanceScore, fairnessScore, ... }
  hardConstraintResults Json?       // { activeDriver: true, slotCapacity: false, ... }

  isActive  Boolean @default(true)  // mark the “current” assignment vs old ones

  createdAt DateTime @default(now())

  @@index([jobId])
  @@index([driverId])
}

model SystemSettings {
  id        Int      @id @default(1)

  // Feature flags / modes
  demoMode           Boolean @default(false)  // toggle between mock-repo vs DB repo
  autoAssignScheduled Boolean @default(false)

  // Email / notifications
  emailFromAddress   String?                  // for confirmation emails
  supportEmail       String?

  // You can also tuck assignment defaults here if not in a separate table
  assignmentConfig   Json?     // optional: mirror your AssignmentConfig type

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model ProofPhoto {
  id        String   @id @default(cuid())

  jobId     String
  job       Job      @relation(fields: [jobId], references: [id])

  stopId    String?
  stop      JobStop? @relation(fields: [stopId], references: [id])

  driverId  String?
  driver    Driver?  @relation(fields: [driverId], references: [id])

  url       String
  takenAt   DateTime @default(now())
  metadata  Json?

  createdAt DateTime @default(now())
}
